<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - {{ username }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .header .username {
            font-size: 1.5em;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .success-message {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border: 1px solid #10b981;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
            color: #065f46;
            font-weight: 600;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: #f3f4f6;
            border-radius: 15px;
            padding: 5px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: #6b7280;
        }

        .tab-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-container {
            background: #fafafa;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #f0f0f0;
        }

        .form-section {
            margin-bottom: 30px;
        }

        .form-section h3 {
            color: #374151;
            margin-bottom: 20px;
            font-size: 1.2em;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e7eb;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 15px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 16px;
            font-family: 'Kanit', sans-serif;
            transition: all 0.3s ease;
            background: white;
            color: #1f2937;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group .description {
            font-size: 13px;
            color: #6b7280;
            margin-top: 5px;
        }

        .color-input {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .color-input input[type="color"] {
            width: 60px;
            height: 40px;
            padding: 0;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
        }

        .range-input {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .range-input input[type="range"] {
            flex: 1;
        }

        .range-input .value {
            background: #f3f4f6;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: 600;
            color: #374151;
            min-width: 60px;
            text-align: center;
        }

        .preview-section {
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            border: 1px solid #d1d5db;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }

        .preview-section h4 {
            color: #374151;
            margin-bottom: 15px;
            text-align: center;
        }

        .preview-widget {
            background: #000;
            border-radius: 10px;
            padding: 20px;
            min-height: 200px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .preview-alert {
            text-align: center;
            padding: 20px;
            border-radius: 15px;
            transform: scale(0.8);
        }

        .save-btn {
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            font-family: 'Kanit', sans-serif;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .links-section {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border: 1px solid #93c5fd;
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .links-section h3 {
            color: #1e40af;
            margin-bottom: 20px;
            font-size: 1.3em;
            text-align: center;
        }

        .links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .link-card {
            background: white;
            border: 1px solid #bae6fd;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .link-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }

        .link-card a {
            color: #1e40af;
            text-decoration: none;
            font-weight: 600;
            font-size: 16px;
        }

        .link-card .desc {
            color: #64748b;
            font-size: 13px;
            margin-top: 5px;
        }

        .url-section {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 1px solid #16a34a;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 20px;
        }

        .url-section h4 {
            color: #166534;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .url-display {
            background: white;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 14px;
            word-break: break-all;
            border: 1px solid #bbf7d0;
            color: #166534;
            margin-bottom: 15px;
        }

        .copy-btn {
            padding: 10px 20px;
            background: #16a34a;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .copy-btn:hover {
            background: #15803d;
            transform: translateY(-1px);
        }

        .status-message {
            padding: 15px 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            margin-top: 20px;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.4s ease;
        }

        .status-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .status-message.success {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status-message.error {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            color: #dc2626;
            border: 1px solid #ef4444;
        }

        /* Bank Settings Specific Styles */
        .bank-settings-group {
            background: linear-gradient(135deg, #e0f2fe, #b3e5fc);
            border: 1px solid #81d4fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
        }

        .test-connection-btn {
            width: 100%;
            padding: 12px 20px;
            background: #0277bd;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .test-connection-btn:hover {
            background: #01579b;
            transform: translateY(-1px);
        }

        .test-connection-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        @media (max-width: 768px) {
            .container {
                padding: 25px;
            }

            .header h1 {
                font-size: 2em;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .links-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>‚öôÔ∏è Settings</h1>
            <div class="username">{{ username }}</div>
            <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>

        <!-- Success message for new users -->
        <div class="success-message" style="display: {{ isNewUser }};">
            üéâ ‡∏™‡∏£‡πâ‡∏≤‡∏á User ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab(event, 'basic')">üì± ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</button>
            <button class="tab-btn" onclick="switchTab(event, 'widget')">üé® ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Widget</button>
            <button class="tab-btn" onclick="switchTab(event, 'advanced')">üîß ‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á</button>
            <button class="tab-btn" onclick="switchTab(event, 'links')">üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå</button>
        </div>

        <!-- Basic Settings Tab -->
        <div id="basic-tab" class="tab-content active">
            <div class="form-container">
                <div class="form-section">
                    <h3>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏•‡∏±‡∏Å</h3>
                    <form id="configForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="truewalletPhone">üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå TrueWallet</label>
                                <input type="tel" id="truewalletPhone" placeholder="0801234567" required>
                            </div>

                            <div class="form-group">
                                <label for="streamTitle">üì∫ ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ï‡∏£‡∏µ‡∏°</label>
                                <input type="text" id="streamTitle" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ï‡∏£‡∏µ‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì" required>
                            </div>

                            <div class="form-group">
                                <label for="alertDuration">‚è±Ô∏è ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏™‡∏î‡∏á Alert (‡∏°‡∏¥‡∏•‡∏•‡∏¥‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)</label>
                                <input type="number" id="alertDuration" min="3000" max="15000" step="1000">
                            </div>

                            <div class="form-group">
                                <label for="minTTSAmount">üó£Ô∏è ‡∏¢‡∏≠‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö TTS (‡∏ö‡∏≤‡∏ó)</label>
                                <input type="number" id="minTTSAmount" min="0" step="1">
                                <div class="description">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</div>
                            </div>

                            <div class="form-group">
                                <label for="enableTTS">üîä ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô TTS (‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)</label>
                                <select id="enableTTS">
                                    <option value="true">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                                    <option value="false">‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="enableTTSName">üë§ ‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÇ‡∏î‡πÄ‡∏ô‡∏ó</label>
                                <select id="enableTTSName">
                                    <option value="true">‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏î‡πâ‡∏ß‡∏¢</option>
                                    <option value="false">‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠</option>
                                </select>
                                <div class="description">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô TTS ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÇ‡∏î‡πÄ‡∏ô‡∏ó‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà</div>
                            </div>
                            
                            <div class="form-group">
                                <label for="enableTTSMessage">üí¨ ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏î‡πÄ‡∏ô‡∏ó</label>
                                <select id="enableTTSMessage">
                                    <option value="true">‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢</option>
                                    <option value="false">‡πÑ‡∏°‡πà‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</option>
                                </select>
                                <div class="description">‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô TTS ‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡∏°‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà</div>
                            </div>

                            <div class="form-group">
                                <label for="enableSound">üéµ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</label>
                                <select id="enableSound">
                                    <option value="true">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                                    <option value="false">‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Bank Settings Section -->
                <div class="form-section">
                    <h3>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="enableBankTransfer">üîÑ ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÇ‡∏≠‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                            <select id="enableBankTransfer" onchange="toggleBankSettings()">
                                <option value="false">‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                                <option value="true">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</option>
                            </select>
                            <div class="description">‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ä‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏î‡πÄ‡∏ô‡∏ó‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏î‡πâ</div>
                        </div>
                    </div>

                    <div class="bank-settings-group" id="bankSettingsGroup" style="display: none;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="bankName">üè¶ ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</label>
                                <select id="bankName">
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</option>
                                    <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û (BBL)</option>
                                    <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏™‡∏¥‡∏Å‡∏£‡πÑ‡∏ó‡∏¢ (KBANK)</option>
                                    <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ó‡∏¢‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå (SCB)</option>
                                    <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡πÑ‡∏ó‡∏¢ (KTB)</option>
                                    <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ó‡∏´‡∏≤‡∏£‡πÑ‡∏ó‡∏¢ (TMB)</option>
                                    <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏Å‡∏£‡∏∏‡∏á‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤ (BAY)</option>
                                    <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ô‡∏≤‡∏Ñ‡∏¥‡∏ô">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏Å‡∏µ‡∏¢‡∏£‡∏ï‡∏¥‡∏ô‡∏≤‡∏Ñ‡∏¥‡∏ô (KKP)</option>
                                    <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ã‡∏µ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏°‡∏ö‡∏µ ‡πÑ‡∏ó‡∏¢">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ã‡∏µ‡πÑ‡∏≠‡πÄ‡∏≠‡πá‡∏°‡∏ö‡∏µ ‡πÑ‡∏ó‡∏¢ (CIMB)</option>
                                    <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏¢‡∏π‡πÇ‡∏≠‡∏ö‡∏µ">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏¢‡∏π‡πÇ‡∏≠‡∏ö‡∏µ (UOB)</option>
                                    <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏•‡∏ô‡∏î‡πå ‡πÅ‡∏≠‡∏ô‡∏î‡πå ‡πÄ‡∏Æ‡∏≤‡∏™‡πå">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÅ‡∏•‡∏ô‡∏î‡πå ‡πÅ‡∏≠‡∏ô‡∏î‡πå ‡πÄ‡∏Æ‡∏≤‡∏™‡πå (LH Bank)</option>
                                    <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≠‡∏°‡∏™‡∏¥‡∏ô (GSB)</option>
                                    <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏≤‡∏Ñ‡∏≤‡∏£‡∏™‡∏á‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (GHB)</option>
                                    <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£">
                                        ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£‡πÅ‡∏•‡∏∞‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£ (BAAC)</option>
                                    <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏¥‡∏™‡∏•‡∏≤‡∏°‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡∏≠‡∏¥‡∏™‡∏•‡∏≤‡∏°‡πÅ‡∏´‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢ (IBANK)</option>
                                    <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏≠‡∏ã‡∏µ‡∏ö‡∏µ‡∏ã‡∏µ">‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏≠‡∏ã‡∏µ‡∏ö‡∏µ‡∏ã‡∏µ (ICBC)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="bankAccount">üí≥ ‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                                <input type="text" id="bankAccount" placeholder="xxx-x-xxxxx-x" maxlength="20">
                                <div class="description">‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏ä‡∏°‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤ (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ)</div>
                            </div>

                            <div class="form-group">
                                <label for="bankAccountName">üë§ ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label>
                                <input type="text" id="bankAccountName" placeholder="‡∏ô‡∏≤‡∏¢/‡∏ô‡∏≤‡∏á ‡∏ä‡∏∑‡πà‡∏≠ ‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"
                                    maxlength="50">
                                <div class="description">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</div>
                            </div>
                        </div>

                        <button type="button" class="test-connection-btn" onclick="testSlipConnection()"
                            id="testConnectionBtn">
                            üîç ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget Customization Tab -->
        <div id="widget-tab" class="tab-content">
            <div class="form-container">
                <div class="form-section">
                    <h3>‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="alertFormat">üìù ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Alert</label>
                            <input type="text" id="alertFormat" placeholder="{{user}} ‡πÇ‡∏î‡πÄ‡∏ô‡∏ó {{amount}}">
                            <div class="description">‡πÉ‡∏ä‡πâ {{user}} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏î‡πÄ‡∏ô‡∏ó ‡πÅ‡∏•‡∏∞ {{amount}} ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="showBackground">üé® ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</label>
                            <select id="showBackground">
                                <option value="true">‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</option>
                                <option value="false">‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á (‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="showIcon">üéâ ‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</label>
                            <select id="showIcon">
                                <option value="true">‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</option>
                                <option value="false">‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="showSparkles">‚ú® ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå Sparkles</label>
                            <select id="showSparkles">
                                <option value="true">‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå</option>
                                <option value="false">‡πÑ‡∏°‡πà‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏≠‡∏ü‡πÄ‡∏ü‡∏Å‡∏ï‡πå</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="useCustomGif">üé¨ ‡πÉ‡∏ä‡πâ GIF ‡πÅ‡∏ó‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</label>
                            <select id="useCustomGif">
                                <option value="false">‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏≠‡∏µ‡πÇ‡∏°‡∏à‡∏¥</option>
                                <option value="true">‡πÉ‡∏ä‡πâ GIF ‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="customGifUrl">üîó URL ‡∏Ç‡∏≠‡∏á GIF</label>
                            <input type="url" id="customGifUrl" placeholder="https://example.com/animation.gif">
                            <div class="description">‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå GIF ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ó‡∏ô‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô (‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å resize ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏Ç‡∏ô‡∏≤‡∏î</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="backgroundColor">üé® ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á</label>
                            <div class="color-input">
                                <input type="color" id="backgroundColorPicker" value="#ffffff">
                                <input type="text" id="backgroundColor" placeholder="rgba(255, 255, 255, 0.95)">
                            </div>
                            <div class="description">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÉ‡∏ä‡πâ rgba() ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™</div>
                        </div>

                        <div class="form-group">
                            <label for="textColor">üìù ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°</label>
                            <div class="color-input">
                                <input type="color" id="textColorPicker" value="#1f2937">
                                <input type="text" id="textColor" placeholder="#1f2937">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="donorColor">üë§ ‡∏™‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÇ‡∏î‡πÄ‡∏ô‡∏ó</label>
                            <div class="color-input">
                                <input type="color" id="donorColorPicker" value="#667eea">
                                <input type="text" id="donorColor" placeholder="#667eea">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="amountColor">üí∞ ‡∏™‡∏µ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                            <div class="color-input">
                                <input type="color" id="amountColorPicker" value="#f59e0b">
                                <input type="text" id="amountColor" placeholder="#f59e0b">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="messageColor">üí¨ ‡∏™‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏î‡πÄ‡∏ô‡∏ó</label>
                            <div class="color-input">
                                <input type="color" id="messageColorPicker" value="#6b7280">
                                <input type="text" id="messageColor" placeholder="#6b7280">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="fontSize">üìè ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£: <span id="fontSizeValue">42</span>px</label>
                            <div class="range-input">
                                <input type="range" id="fontSize" min="12" max="100" value="42"
                                    oninput="updateRangeValue('fontSize', 'fontSizeValue')">
                                <div class="value" id="fontSizeDisplay">42px</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="amountSize">üí∞ ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏á‡∏¥‡∏ô: <span id="amountSizeValue">56</span>px</label>
                            <div class="range-input">
                                <input type="range" id="amountSize" min="12" max="120" value="56"
                                    oninput="updateRangeValue('amountSize', 'amountSizeValue')">
                                <div class="value" id="amountSizeDisplay">56px</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="borderRadius">üî≤ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏Ñ‡πâ‡∏á‡∏°‡∏∏‡∏°: <span id="borderRadiusValue">25</span>px</label>
                            <div class="range-input">
                                <input type="range" id="borderRadius" min="0" max="50" value="25"
                                    oninput="updateRangeValue('borderRadius', 'borderRadiusValue')">
                                <div class="value" id="borderRadiusDisplay">25px</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="animationSpeed">üé¨ ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß Animation: <span
                                    id="animationSpeedValue">1.2</span>x</label>
                            <div class="range-input">
                                <input type="range" id="animationSpeed" min="0.1" max="5" step="0.1" value="1.2"
                                    oninput="updateRangeValue('animationSpeed', 'animationSpeedValue')">
                                <div class="value" id="animationSpeedDisplay">1.2x</div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="messageSize">üí¨ ‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: <span id="messageSizeValue">24</span>px</label>
                            <div class="range-input">
                                <input type="range" id="messageSize" min="12" max="48" value="24"
                                    oninput="updateRangeValue('messageSize', 'messageSizeValue')">
                                <div class="value" id="messageSizeDisplay">24px</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preview Section -->
                <div class="preview-section">
                    <h4>üîç ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á Widget</h4>
                    <div class="preview-widget" id="previewWidget">
                        <div class="preview-alert" id="previewAlert">
                            <div style="font-size: 42px; margin-bottom: 10px;">
                                <span style="color: #667eea; font-weight: 900;">‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</span> ‡πÇ‡∏î‡πÄ‡∏ô‡∏ó
                                <span
                                    style="color: #f59e0b; font-size: 56px; font-weight: 900; display: block;">500</span>
                            </div>
                            <div style="font-style: italic; color: #6b7280;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button type="button" onclick="updatePreview()"
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">üîÑ
                            ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Advanced Settings Tab -->
        <div id="advanced-tab" class="tab-content">
            <div class="form-container">
                <div class="form-section">
                    <h3>‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á</h3>
                    <div class="form-group">
                        <label for="customCSS">üé® Custom CSS</label>
                        <textarea id="customCSS" placeholder="/* ‡πÉ‡∏™‡πà CSS ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà */"></textarea>
                        <div class="description">CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Widget ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</div>
                    </div>

                    <div class="form-group">
                        <label for="welcomeMessage">üí¨ ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö</label>
                        <textarea id="welcomeMessage" placeholder="‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏ï‡∏£‡∏µ‡∏°‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô!"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Links Tab -->
        <div id="links-tab" class="tab-content">
            <div class="links-section">
                <h3>üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö {{ username }}</h3>
                <div class="links-grid">
                    <div class="link-card">
                        <a href="/user/{{ username }}/donate" target="_blank">üíù Donate Page</a>
                        <div class="desc">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏ä‡∏°</div>
                    </div>
                    <div class="link-card">
                        <a href="/user/{{ username }}/widget" target="_blank">üì∫ Alert Widget</a>
                        <div class="desc">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OBS</div>
                    </div>
                    <div class="link-card">
                        <a href="/user/{{ username }}/control" target="_blank">üéÆ Control Panel</a>
                        <div class="desc">‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Alert</div>
                    </div>
                    <div class="link-card">
                        <a href="/user/{{ username }}/history" target="_blank">üìä History</a>
                        <div class="desc">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô</div>
                    </div>
                </div>

                <!-- OBS Widget URL -->
                <div class="url-section">
                    <h4>üìã URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö OBS Browser Source:</h4>
                    <div class="url-display" id="widgetUrl">{{ widgetUrl }}</div>
                    <button class="copy-btn" onclick="copyUrl('widgetUrl')">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Widget URL</button>
                </div>

                <!-- Donate URL -->
                <div class="url-section">
                    <h4>üíù URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÇ‡∏î‡πÄ‡∏ô‡∏ó:</h4>
                    <div class="url-display" id="donateUrl">{{ donateUrl }}</div>
                    <button class="copy-btn" onclick="copyUrl('donateUrl')">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Donate URL</button>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <button type="submit" class="save-btn" onclick="saveConfig()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>

        <div style="text-align: center; margin-top: 30px;">
            <a href="/" style="color: #667eea; text-decoration: none; font-weight: 600;">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a>
        </div>

        <div id="statusMessage" class="status-message"></div>
    </div>

    <script>
        let currentConfig = {};

        // Load current config
        document.addEventListener('DOMContentLoaded', async () => {
    try {
        console.log('üîç Initializing config page...');
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        const sessionCheckResponse = await fetch('/user/{{ username }}/api/session-status', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
            },
            credentials: 'same-origin'
        });

        if (sessionCheckResponse.status === 401) {
            console.log('‚ùå Session not valid, redirecting to login...');
            showStatus('üîí ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Settings', 'error');
            
            setTimeout(() => {
                const returnUrl = encodeURIComponent(window.location.href);
                window.location.href = `/user/{{ username }}/login?return=${returnUrl}`;
            }, 2000);
            return;
        }

        console.log('‚úÖ Session validation passed');

        // ‡πÇ‡∏´‡∏•‡∏î config
        let configLoaded = false;
        
        const configResponse = await fetch('/user/{{ username }}/api/config', {
            method: 'GET',
            headers: {
                'Accept': 'application/json',
            },
            credentials: 'same-origin'
        });

        if (configResponse.ok) {
            const data = await configResponse.json();
            if (data.success && data.config) {
                currentConfig = data.config;
                configLoaded = true;
                console.log('‚úÖ Config loaded from API:', currentConfig);
            }
        }

        // Fallback to template data
        if (!configLoaded) {
            const configStr = `{{ config }}`.trim();
            if (configStr && configStr !== '{{ config }}' && configStr !== '') {
                try {
                    const unescapedConfig = configStr
                        .replace(/&quot;/g, '"')
                        .replace(/&amp;/g, '&')
                        .replace(/&lt;/g, '<')
                        .replace(/&gt;/g, '>')
                        .replace(/&#039;/g, "'");

                    currentConfig = JSON.parse(unescapedConfig);
                    configLoaded = true;
                    console.log('‚úÖ Config loaded from template:', currentConfig);
                } catch (e) {
                    console.warn('Failed to parse config from template:', e);
                }
            }
        }

        // Default config
        if (!configLoaded) {
            console.log('‚ö†Ô∏è Using default config');
            currentConfig = getDefaultConfig();
        }

        // Setup UI
        populateForm(currentConfig);
        setupColorPickers();
        updatePreview();

        // ‡πÄ‡∏£‡∏¥‡πà‡∏° session keep-alive
        startSessionKeepAlive();

        console.log('üéâ Config page loaded successfully');

    } catch (error) {
        console.error('üí• Error in config initialization:', error);
        
        // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô network error
        if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            showStatus('üîí ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÑ‡∏î‡πâ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô...', 'error');
            setTimeout(() => {
                const returnUrl = encodeURIComponent(window.location.href);
                window.location.href = `/user/{{ username }}/login?return=${returnUrl}`;
            }, 2000);
            return;
        }
        
        // ‡πÉ‡∏ä‡πâ default config ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á error
        currentConfig = getDefaultConfig();
        populateForm(currentConfig);
        setupColorPickers();
        updatePreview();
        
        showStatus('‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô', 'error');
    }
});

        function getDefaultConfig() {
            return {
                truewalletPhone: '',
                streamTitle: '{{ username }}\'s Stream',
                alertDuration: 5000,
                enableTTS: true,
                enableTTSName: true,
                enableTTSMessage: true,
                enableSound: true,
                alertFormat: '{{user}} ‡πÇ‡∏î‡πÄ‡∏ô‡∏ó {{amount}}',
                minTTSAmount: 50,

                // Bank settings
                enableBankTransfer: false,
                bankName: '',
                bankAccount: '',
                bankAccountName: '',

                // Widget settings
                showBackground: false,
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                textColor: '#1f2937',
                amountColor: '#f59e0b',
                donorColor: '#667eea',
                messageColor: '#6b7280',
                fontSize: 42,
                amountSize: 56,
                messageSize: 24,
                borderRadius: 25,
                showIcon: true,
                showSparkles: true,
                animationSpeed: 1.2,
                customCSS: '',
                welcomeMessage: '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏ï‡∏£‡∏µ‡∏°‡∏Ç‡∏≠‡∏á {{ username }}!',
                useCustomGif: false,
                customGifUrl: ''
            };
        }

        function populateForm(config) {
            // Basic settings
            document.getElementById('truewalletPhone').value = config.truewalletPhone || '';
            document.getElementById('streamTitle').value = config.streamTitle || '';
            document.getElementById('alertDuration').value = config.alertDuration || 5000;
            document.getElementById('minTTSAmount').value = config.minTTSAmount || 50;
            document.getElementById('enableTTS').value = config.enableTTS ? 'true' : 'false';
            document.getElementById('enableTTSName').value = config.enableTTSName !== false ? 'true' : 'false';
            document.getElementById('enableTTSMessage').value = config.enableTTSMessage !== false ? 'true' : 'false';
            document.getElementById('enableSound').value = config.enableSound ? 'true' : 'false';

            // Bank settings
            document.getElementById('enableBankTransfer').value = config.enableBankTransfer ? 'true' : 'false';
            document.getElementById('bankName').value = config.bankName || '';
            document.getElementById('bankAccount').value = config.bankAccount || '';
            document.getElementById('bankAccountName').value = config.bankAccountName || '';

            // Widget customization
            document.getElementById('alertFormat').value = config.alertFormat || '{{user}} ‡πÇ‡∏î‡πÄ‡∏ô‡∏ó {{amount}}';
            document.getElementById('showBackground').value = config.showBackground === true ? 'true' : 'false';
            document.getElementById('showIcon').value = config.showIcon !== false ? 'true' : 'false';
            document.getElementById('showSparkles').value = config.showSparkles !== false ? 'true' : 'false';
            document.getElementById('useCustomGif').value = config.useCustomGif === true ? 'true' : 'false';
            document.getElementById('customGifUrl').value = config.customGifUrl || '';
            document.getElementById('backgroundColor').value = config.backgroundColor || 'rgba(255, 255, 255, 0.95)';
            document.getElementById('textColor').value = config.textColor || '#1f2937';
            document.getElementById('amountColor').value = config.amountColor || '#f59e0b';
            document.getElementById('donorColor').value = config.donorColor || '#667eea';
            document.getElementById('messageColor').value = config.messageColor || '#6b7280';
            document.getElementById('fontSize').value = config.fontSize || 42;
            document.getElementById('amountSize').value = config.amountSize || 56;
            document.getElementById('messageSize').value = config.messageSize || 24;
            document.getElementById('borderRadius').value = config.borderRadius || 25;
            document.getElementById('animationSpeed').value = config.animationSpeed || 1.2;

            // Advanced
            document.getElementById('customCSS').value = config.customCSS || '';
            document.getElementById('welcomeMessage').value = config.welcomeMessage || '';

            // Update range displays
            updateRangeValue('fontSize', 'fontSizeValue');
            updateRangeValue('amountSize', 'amountSizeValue');
            updateRangeValue('messageSize', 'messageSizeValue');
            updateRangeValue('borderRadius', 'borderRadiusValue');
            updateRangeValue('animationSpeed', 'animationSpeedValue');

            // Toggle bank settings visibility
            toggleBankSettings();
        }

        function setupColorPickers() {
            // Setup color picker synchronization
            const colorInputs = [
                { picker: 'backgroundColorPicker', text: 'backgroundColor', defaultColor: '#ffffff' },
                { picker: 'textColorPicker', text: 'textColor', defaultColor: '#1f2937' },
                { picker: 'amountColorPicker', text: 'amountColor', defaultColor: '#f59e0b' },
                { picker: 'donorColorPicker', text: 'donorColor', defaultColor: '#667eea' },
                { picker: 'messageColorPicker', text: 'messageColor', defaultColor: '#6b7280' }
            ];

            colorInputs.forEach(({ picker, text }) => {
                const pickerEl = document.getElementById(picker);
                const textEl = document.getElementById(text);

                if (!pickerEl || !textEl) return;

                pickerEl.addEventListener('change', () => {
                    textEl.value = pickerEl.value;
                    updatePreview();
                });

                textEl.addEventListener('input', () => {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ hex ‡πÉ‡∏´‡πâ sync ‡πÑ‡∏õ color picker
                    if (textEl.value.startsWith('#') && textEl.value.length === 7) {
                        pickerEl.value = textEl.value;
                    }
                    updatePreview();
                });
            });

            // ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å setup event listeners
            setTimeout(() => {
                syncColorPickers();
            }, 100);
        }

        function syncColorPickers() {
            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ñ‡πà‡∏≤‡∏™‡∏µ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á color picker ‡πÅ‡∏•‡∏∞ text input
            const colorInputs = [
                { picker: 'backgroundColorPicker', text: 'backgroundColor', defaultColor: '#ffffff' },
                { picker: 'textColorPicker', text: 'textColor', defaultColor: '#1f2937' },
                { picker: 'amountColorPicker', text: 'amountColor', defaultColor: '#f59e0b' },
                { picker: 'donorColorPicker', text: 'donorColor', defaultColor: '#667eea' },
                { picker: 'messageColorPicker', text: 'messageColor', defaultColor: '#6b7280' }
            ];

            colorInputs.forEach(({ picker, text, defaultColor }) => {
                const pickerEl = document.getElementById(picker);
                const textEl = document.getElementById(text);

                if (!pickerEl || !textEl) return;

                const textValue = textEl.value;

                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ hex ‡πÉ‡∏´‡πâ sync ‡πÑ‡∏õ color picker
                if (textValue && textValue.startsWith('#') && textValue.length === 7) {
                    pickerEl.value = textValue;
                } else if (textValue && textValue.startsWith('rgba')) {
                    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô rgba ‡πÉ‡∏´‡πâ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô hex ‡πÅ‡∏•‡πâ‡∏ß sync
                    const hex = rgbaToHex(textValue);
                    if (hex) {
                        pickerEl.value = hex;
                    } else {
                        pickerEl.value = defaultColor;
                    }
                } else {
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤ default
                    pickerEl.value = defaultColor;
                    textEl.value = defaultColor;
                }
            });
        }

        function rgbaToHex(rgba) {
            // ‡πÅ‡∏õ‡∏•‡∏á rgba ‡πÄ‡∏õ‡πá‡∏ô hex (‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏° alpha)
            const match = rgba.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
            if (match) {
                const r = parseInt(match[1]).toString(16).padStart(2, '0');
                const g = parseInt(match[2]).toString(16).padStart(2, '0');
                const b = parseInt(match[3]).toString(16).padStart(2, '0');
                return `#${r}${g}${b}`;
            }
            return null;
        }

        function switchTab(event, tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        function updateRangeValue(rangeId, valueId) {
            const range = document.getElementById(rangeId);
            const value = document.getElementById(valueId);
            const display = document.getElementById(rangeId + 'Display');

            value.textContent = range.value;
            if (display) {
                display.textContent = range.value + (rangeId === 'animationSpeed' ? 'x' : 'px');
            }

            updatePreview();
        }

        function updatePreview() {
            const preview = document.getElementById('previewAlert');
            const widget = document.getElementById('previewWidget');

            const showBackground = document.getElementById('showBackground').value === 'true';
            const backgroundColor = document.getElementById('backgroundColor').value;
            const textColor = document.getElementById('textColor').value;
            const amountColor = document.getElementById('amountColor').value;
            const donorColor = document.getElementById('donorColor').value;
            const messageColor = document.getElementById('messageColor').value;
            const fontSize = document.getElementById('fontSize').value;
            const amountSize = document.getElementById('amountSize').value;
            const messageSize = document.getElementById('messageSize').value;
            const borderRadius = document.getElementById('borderRadius').value;
            const alertFormat = document.getElementById('alertFormat').value;
            const useCustomGif = document.getElementById('useCustomGif').value === 'true';
            const customGifUrl = document.getElementById('customGifUrl').value;
            const showIcon = document.getElementById('showIcon').value === 'true';

            // Update preview styles
            if (showBackground) {
                preview.style.background = backgroundColor;
                preview.style.border = '1px solid rgba(255,255,255,0.3)';
            } else {
                preview.style.background = 'transparent';
                preview.style.border = 'none';
            }

            preview.style.borderRadius = borderRadius + 'px';
            preview.style.color = textColor;

            // Update text content based on format
            let formattedText = alertFormat
                .replace('{{user}}', `<span style="color: ${donorColor}; font-weight: 900;">‡∏ú‡∏π‡πâ‡∏ó‡∏î‡∏™‡∏≠‡∏ö</span>`)
                .replace('{{amount}}', `<span style="color: ${amountColor}; font-size: ${amountSize}px; font-weight: 900; display: block;">‡∏ø500</span>`);

            // Add icon/gif preview
            let iconHtml = '';
            if (showIcon) {
                if (useCustomGif && customGifUrl) {
                    iconHtml = `<div style="width: 80px; height: 80px; margin: 0 auto 15px; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.2);">
                        <img src="${customGifUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.style.display='none'">
                    </div>`;
                } else {
                    iconHtml = `<div style="width: 80px; height: 80px; margin: 0 auto 15px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);">üéâ</div>`;
                }
            }

            preview.innerHTML = `
                ${iconHtml}
                <div style="font-size: ${fontSize}px; margin-bottom: 10px;">
                    ${formattedText}
                </div>
                <div style="font-style: italic; color: ${messageColor}; margin-top: 10px; font-size: ${messageSize}px;">‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö</div>
            `;
        }

        function toggleBankSettings() {
            const enableBankTransfer = document.getElementById('enableBankTransfer').value === 'true';
            const bankSettingsGroup = document.getElementById('bankSettingsGroup');

            if (bankSettingsGroup) {
                bankSettingsGroup.style.display = enableBankTransfer ? 'block' : 'none';
            }
        }

        async function testSlipConnection() {
            const testBtn = document.getElementById('testConnectionBtn');
            const originalText = testBtn.textContent;

            testBtn.disabled = true;
            testBtn.textContent = 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';

            try {
                const response = await fetch('/user/{{ username }}/api/test-slip-connection');
                const result = await response.json();

                if (result.success && result.connected) {
                    showStatus('‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                } else {
                    showStatus('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡πÑ‡∏î‡πâ', 'error');
                }
            } catch (error) {
                console.error('Error testing slip connection:', error);
                showStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏î‡∏™‡∏≠‡∏ö', 'error');
            } finally {
                testBtn.disabled = false;
                testBtn.textContent = originalText;
            }
        }

        async function saveConfig() {
    const config = {
        // ... (config data same as before)
        truewalletPhone: document.getElementById('truewalletPhone').value,
        streamTitle: document.getElementById('streamTitle').value,
        alertDuration: parseInt(document.getElementById('alertDuration').value),
        enableTTS: document.getElementById('enableTTS').value === 'true',
        enableTTSName: document.getElementById('enableTTSName').value === 'true',
        enableTTSMessage: document.getElementById('enableTTSMessage').value === 'true',
        enableSound: document.getElementById('enableSound').value === 'true',
        minTTSAmount: parseInt(document.getElementById('minTTSAmount').value) || 0,

        // Bank settings
        enableBankTransfer: document.getElementById('enableBankTransfer').value === 'true',
        bankName: document.getElementById('bankName').value,
        bankAccount: document.getElementById('bankAccount').value,
        bankAccountName: document.getElementById('bankAccountName').value,

        // Widget customization
        alertFormat: document.getElementById('alertFormat').value,
        showBackground: document.getElementById('showBackground').value === 'true',
        showIcon: document.getElementById('showIcon').value === 'true',
        showSparkles: document.getElementById('showSparkles').value === 'true',
        useCustomGif: document.getElementById('useCustomGif').value === 'true',
        customGifUrl: document.getElementById('customGifUrl').value,
        backgroundColor: document.getElementById('backgroundColor').value,
        textColor: document.getElementById('textColor').value,
        amountColor: document.getElementById('amountColor').value,
        donorColor: document.getElementById('donorColor').value,
        messageColor: document.getElementById('messageColor').value,
        fontSize: parseInt(document.getElementById('fontSize').value),
        amountSize: parseInt(document.getElementById('amountSize').value),
        messageSize: parseInt(document.getElementById('messageSize').value),
        borderRadius: parseInt(document.getElementById('borderRadius').value),
        animationSpeed: parseFloat(document.getElementById('animationSpeed').value),

        // Advanced
        customCSS: document.getElementById('customCSS').value,
        welcomeMessage: document.getElementById('welcomeMessage').value
    };

    try {
        console.log('üíæ Attempting to save config...');

        // üîß ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
        const sessionCheck = await fetch('/user/{{ username }}/api/session-status', {
            method: 'GET',
            credentials: 'same-origin'
        });

        if (sessionCheck.status === 401) {
            throw new Error('SESSION_EXPIRED');
        }

        const response = await fetch('/user/{{ username }}/api/config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            },
            credentials: 'same-origin',
            body: JSON.stringify(config)
        });

        console.log('üì° Save response status:', response.status);

        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Content-Type ‡∏Å‡πà‡∏≠‡∏ô parse
        const contentType = response.headers.get('Content-Type');
        
        if (!contentType || !contentType.includes('application/json')) {
            const responseText = await response.text();
            
            if (responseText.includes('<!DOCTYPE') || responseText.includes('<html')) {
                throw new Error('SESSION_EXPIRED');
            } else {
                throw new Error(`Server returned unexpected content type: ${contentType}`);
            }
        }

        const result = await response.json();
        console.log('üìã Save result:', result);

        if (response.status === 401 || result.code === 'AUTH_REQUIRED') {
            throw new Error('SESSION_EXPIRED');
        }

        if (response.ok && result.success) {
            showStatus('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            currentConfig = config;
            
            // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï error counter ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            sessionErrorCount = 0;
        } else {
            const errorMessage = result.message || `HTTP ${response.status}: ${response.statusText}`;
            showStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + errorMessage, 'error');
        }

    } catch (error) {
        console.error('üí• Save config error:', error);
        
        if (error.message === 'SESSION_EXPIRED') {
            showStatus('üîí Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô...', 'error');
            setTimeout(() => {
                window.location.href = `/user/{{ username }}/login?return=${encodeURIComponent(window.location.href)}`;
            }, 2000);
        } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
            showStatus('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÑ‡∏î‡πâ', 'error');
        } else {
            showStatus('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message, 'error');
        }
    }
}

        function copyUrl(elementId) {
            const urlElement = document.getElementById(elementId);
            const url = urlElement.textContent;

            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    showStatus('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }).catch(err => {
                    console.error('Error copying URL:', err);
                    fallbackCopy(url);
                });
            } else {
                fallbackCopy(url);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');
                showStatus('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å URL ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showStatus('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á', 'error');
            }

            document.body.removeChild(textarea);
        }

        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type} show`;

            setTimeout(() => {
                statusMessage.classList.remove('show');
            }, 4000);
        }

        // Phone number validation
        document.getElementById('truewalletPhone').addEventListener('input', function (e) {
            const phone = e.target.value;
            const isValid = /^[0-9]{10}$/.test(phone);

            if (phone.length > 0 && !isValid) {
                e.target.style.borderColor = '#ef4444';
                e.target.style.boxShadow = '0 0 0 4px rgba(239, 68, 68, 0.1)';
            } else {
                e.target.style.borderColor = '#e5e7eb';
                e.target.style.boxShadow = 'none';
            }
        });

        // Bank account validation
        document.getElementById('bankAccount').addEventListener('input', function (e) {
            const account = e.target.value;
            // ‡∏•‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÅ‡∏•‡∏∞ dash
            const cleaned = account.replace(/[^0-9-]/g, '');
            e.target.value = cleaned;

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö
            const isValid = /^[\d-]{0,20}$/.test(cleaned);

            if (cleaned.length > 0 && !isValid) {
                e.target.style.borderColor = '#ef4444';
                e.target.style.boxShadow = '0 0 0 4px rgba(239, 68, 68, 0.1)';
            } else {
                e.target.style.borderColor = '#e5e7eb';
                e.target.style.boxShadow = 'none';
            }
        });

        
        // Bank account name validation
        document.getElementById('bankAccountName').addEventListener('input', function (e) {
            const name = e.target.value;
            // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÑ‡∏ó‡∏¢ ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡πÅ‡∏•‡∏∞‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á
            const isValid = /^[a-zA-Z‡∏Å-‡πô\s]*$/.test(name);

            if (name.length > 0 && !isValid) {
                e.target.style.borderColor = '#ef4444';
                e.target.style.boxShadow = '0 0 0 4px rgba(239, 68, 68, 0.1)';
            } else {
                e.target.style.borderColor = '#e5e7eb';
                e.target.style.boxShadow = 'none';
            }
        });

        // Auto-update preview when inputs change
        document.addEventListener('input', (e) => {
            if (e.target.closest('#widget-tab')) {
                updatePreview();
            }
        });

        // Initialize preview on load
        window.addEventListener('load', () => {
            updatePreview();
        });

        let sessionKeepAliveInterval;
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏ session ‡∏ó‡∏∏‡∏Å 5 ‡∏ô‡∏≤‡∏ó‡∏µ
        function startSessionKeepAlive() {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö session ‡∏ó‡∏∏‡∏Å 2 ‡∏ô‡∏≤‡∏ó‡∏µ
    sessionKeepAliveInterval = setInterval(async () => {
        try {
            console.log('üîÑ Checking session status...');
            
            const response = await fetch('/user/{{ username }}/api/session-status', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                },
                credentials: 'same-origin'
            });

            if (response.status === 401) {
                console.log('‚ùå Session expired during keep-alive');
                clearInterval(sessionKeepAliveInterval);
                showStatus('üîí Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô...', 'error');
                
                setTimeout(() => {
                    const returnUrl = encodeURIComponent(window.location.href);
                    window.location.href = `/user/{{ username }}/login?return=${returnUrl}`;
                }, 2000);
                return;
            }

            if (response.ok) {
                const sessionInfo = await response.json();
                if (sessionInfo.authenticated) {
                    console.log('‚úÖ Session is valid, time remaining:', Math.round(sessionInfo.timeRemaining / 1000 / 60), 'minutes');
                } else {
                    throw new Error('Session not authenticated');
                }
            } else {
                throw new Error(`HTTP ${response.status}`);
            }
            
        } catch (error) {
            console.error('üí• Session keep-alive error:', error);
            
            // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏î error 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ô ‡πÉ‡∏´‡πâ redirect ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤ login
            sessionErrorCount = (sessionErrorCount || 0) + 1;
            if (sessionErrorCount >= 3) {
                console.log('‚ùå Too many session errors, redirecting to login');
                clearInterval(sessionKeepAliveInterval);
                showStatus('üîí ‡πÄ‡∏Å‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏Å‡∏±‡∏ö Session ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô...', 'error');
                
                setTimeout(() => {
                    const returnUrl = encodeURIComponent(window.location.href);
                    window.location.href = `/user/{{ username }}/login?return=${returnUrl}`;
                }, 2000);
            }
        }
    }, 2 * 60 * 1000); // ‡∏ó‡∏∏‡∏Å 2 ‡∏ô‡∏≤‡∏ó‡∏µ
}
        
        // ‡πÄ‡∏£‡∏¥‡πà‡∏° keep-alive ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        startSessionKeepAlive();
        
        // ‡∏´‡∏¢‡∏∏‡∏î keep-alive ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤
        window.addEventListener('beforeunload', () => {
    if (sessionKeepAliveInterval) {
        clearInterval(sessionKeepAliveInterval);
    }
});

    </script>
</body>

</html>