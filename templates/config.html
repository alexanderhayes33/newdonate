<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settings - {{ username }}</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="shortcut icon" href="https://img5.pic.in.th/file/secure-sv1/Untitled-designd6e3c4dd05e5b3c5.png" type="image/png">
    <link rel="icon" href="https://img5.pic.in.th/file/secure-sv1/Untitled-designd6e3c4dd05e5b3c5.png" type="image/png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --glass-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.7);
            --text-muted: rgba(255, 255, 255, 0.5);
            --bg-dark: #0a0a0f;
            --bg-card: rgba(255, 255, 255, 0.03);
            --primary-color: #667eea;
            --primary-dark: #5a67d8;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-primary: var(--glass-bg);
            --bg-secondary: var(--bg-card);
            --bg-tertiary: rgba(255, 255, 255, 0.08);
            --border-light: rgba(255, 255, 255, 0.1);
            --border-medium: rgba(255, 255, 255, 0.15);
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.4);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4), 0 4px 6px -4px rgb(0 0 0 / 0.4);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.4), 0 8px 10px -6px rgb(0 0 0 / 0.4);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --radius-2xl: 20px;
        }

        body {
            font-family: 'Kanit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-dark);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }

        /* Animated Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background:
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.05) 0%, transparent 50%);
            z-index: -1;
            animation: gradientShift 20s ease-in-out infinite;
        }

        @keyframes gradientShift {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.8;
            }
        }

        .page-wrapper {
            min-height: 100vh;
            padding: 2rem 1rem;
            position: relative;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--radius-2xl);
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            position: relative;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: var(--primary-gradient);
            opacity: 0.6;
        }

        .header {
            background: var(--primary-gradient);
            color: white;
            text-align: center;
            padding: 3rem 2rem 2rem;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: float 20s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            50% {
                transform: translate(-50%, -50%) rotate(180deg);
            }
        }

        .header-content {
            position: relative;
            z-index: 1;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header .username {
            font-size: 1.25rem;
            font-weight: 600;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .header .subtitle {
            font-size: 1rem;
            opacity: 0.8;
            font-weight: 400;
        }

        .success-banner {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-left: 4px solid var(--success-color);
            padding: 1rem 1.5rem;
            margin: 1.5rem;
            border-radius: var(--radius-lg);
            color: #065f46;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            box-shadow: var(--shadow-sm);
        }

        .success-banner i {
            color: var(--success-color);
            font-size: 1.25rem;
        }

        .tabs-container {
            padding: 0 1.5rem;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-light);
        }

        .tabs {
            display: flex;
            gap: 0;
            overflow-x: auto;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .tabs::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            flex: 1;
            min-width: max-content;
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 1rem;
            font-family: 'Kanit', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
        }

        .tab-btn i {
            font-size: 1rem;
        }

        .tab-btn:hover {
            color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .tab-btn.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
            font-weight: 600;
        }

        .tab-content {
            display: none;
            padding: 2rem 1.5rem;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow-sm);
            backdrop-filter: blur(10px);
        }

        .form-section h3 {
            color: var(--text-primary);
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--bg-tertiary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .form-section h3 i {
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-weight: 600;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group label i {
            color: var(--primary-color);
            font-size: 0.875rem;
            width: 16px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-family: 'Kanit', sans-serif;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-primary);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-muted);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.05);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group .description {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
            line-height: 1.4;
        }

        .color-input {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .color-input input[type="color"] {
            width: 50px;
            height: 40px;
            padding: 2px;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            cursor: pointer;
            background: rgba(255, 255, 255, 0.03);
        }

        .color-input input[type="text"] {
            flex: 1;
        }

        .range-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .range-input {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .range-input input[type="range"] {
            flex: 1;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-tertiary);
            outline: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .range-input input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: var(--shadow-md);
        }

        .range-input input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            border: none;
            box-shadow: var(--shadow-md);
        }

        .range-value {
            background: var(--bg-tertiary);
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-md);
            font-weight: 600;
            color: var(--text-primary);
            min-width: 60px;
            text-align: center;
            font-size: 0.875rem;
        }

        .preview-section {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-xl);
            padding: 2rem;
            margin-bottom: 1.5rem;
            backdrop-filter: blur(10px);
        }

        .preview-section h4 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            text-align: center;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .preview-section h4 i {
            color: var(--primary-color);
        }

        .preview-widget {
            background: #000;
            border-radius: var(--radius-lg);
            padding: 2rem;
            min-height: 200px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
        }

        .preview-alert {
            text-align: center;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            transform: scale(0.85);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-weight: 600;
            font-family: 'Kanit', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-medium);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .save-btn {
            width: 100%;
            padding: 1rem 1.5rem;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: var(--radius-lg);
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Kanit', sans-serif;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 2rem 1.5rem 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            box-shadow: var(--shadow-lg);
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .links-section {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #93c5fd;
            border-radius: var(--radius-xl);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .links-section h3 {
            color: #1e40af;
            margin-bottom: 1.5rem;
            font-size: 1.25rem;
            text-align: center;
            font-weight: 700;
        }

        .links-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .link-card {
            background: white;
            border: 1px solid #bae6fd;
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            text-align: center;
            transition: all 0.2s ease;
            box-shadow: var(--shadow-sm);
        }

        .link-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .link-card a {
            color: #1e40af;
            text-decoration: none;
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .link-card .desc {
            color: var(--text-muted);
            font-size: 0.8rem;
            margin-top: 0.5rem;
        }

        .url-section {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 1px solid #16a34a;
            border-radius: var(--radius-xl);
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .url-section h4 {
            color: #166534;
            margin-bottom: 1rem;
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .url-display {
            background: white;
            padding: 1rem;
            border-radius: var(--radius-md);
            font-family: 'Kanit', monospace;
            font-size: 0.95rem;
            font-weight: 500;
            word-break: break-all;
            border: 1px solid #bbf7d0;
            color: #166534;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .status-message {
            padding: 1rem 1.5rem;
            border-radius: var(--radius-lg);
            text-align: center;
            font-weight: 500;
            margin: 1.5rem;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
        }

        .status-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .status-message.success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 1px solid #10b981;
        }

        .status-message.error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #dc2626;
            border: 1px solid #ef4444;
        }

        .bank-settings-group {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            margin-top: 1rem;
            backdrop-filter: blur(10px);
            box-shadow: var(--shadow-sm);
        }
        /* Style สำหรับ select dropdown */
        .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
            font-family: 'Kanit', sans-serif;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.03);
            color: var(--text-primary);
            cursor: pointer;
            
            /* สำหรับ dropdown arrow */
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 16px;
            padding-right: 3rem;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
        }

        .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            background: rgba(255, 255, 255, 0.05);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Style สำหรับ options */
        .form-group select option {
            background: #1a1a24;
            color: #ffffff;
            padding: 0.5rem 1rem;
            font-family: 'Kanit', sans-serif;
            font-size: 0.95rem;
            border: none;
        }

        .form-group select option:hover {
            background: var(--primary-color);
            color: white;
        }

        .form-group select option:checked {
            background: var(--primary-color);
            color: white;
            font-weight: 600;
        }

        .form-group select option:disabled {
            color: var(--text-muted);
            background: rgba(255, 255, 255, 0.05);
        }

        /* สำหรับ select ที่มี placeholder */
        .form-group select:invalid {
            color: var(--text-muted);
        }

        .form-group select option[value=""] {
            color: var(--text-muted);
            font-style: italic;
        }

        /* สำหรับ select เฉพาะใน bank-settings-group */
        .bank-settings-group select {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--border-medium);
        }

        .bank-settings-group select:focus {
            background: rgba(255, 255, 255, 0.12);
        }

        /* เพิ่มเติมสำหรับ Firefox */
        @-moz-document url-prefix() {
            .form-group select {
                background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ffffff' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            }
        }

        /* สำหรับ Mobile */
        @media (max-width: 768px) {
            .form-group select {
                font-size: 16px; /* ป้องกัน zoom ใน iOS */
            }
        }
        .footer-nav {
            text-align: center;
            padding: 2rem 1.5rem 1rem;
            border-top: 1px solid var(--border-light);
            background: var(--bg-card);
        }

        .footer-nav a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s ease;
        }

        .footer-nav a:hover {
            color: var(--primary-dark);
            transform: translateX(-2px);
        }

        @media (max-width: 768px) {
            .page-wrapper {
                padding: 1rem 0.5rem;
            }

            .container {
                margin: 0;
                border-radius: var(--radius-xl);
            }

            .header {
                padding: 2rem 1.5rem 1.5rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .links-grid {
                grid-template-columns: 1fr;
            }

            .tabs {
                flex-direction: column;
            }

            .tab-btn {
                justify-content: flex-start;
                border-bottom: none;
                border-left: 3px solid transparent;
            }

            .tab-btn.active {
                border-left-color: var(--primary-color);
                border-bottom-color: transparent;
            }

            .save-btn {
                margin: 1rem;
            }
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-medium);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Loading states */
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            margin: -10px 0 0 -10px;
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Focus styles for accessibility */
        .btn:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
    </style>
</head>

<body>
    <div class="page-wrapper">
        <div class="container">
            <div class="header">
                <div class="header-content">
                    <h1>Settings</h1>
                    <div class="username">{{ username }}</div>
                    <p class="subtitle">จัดการการตั้งค่าของคุณ</p>
                </div>
            </div>

            <!-- Success message for new users -->
            <div class="success-banner" style="display: {{ isNewUser }};">
                <i class="fas fa-check-circle"></i>
                <span>สร้าง User สำเร็จแล้ว! กรุณาตรวจสอบและปรับแต่งการตั้งค่าด้านล่าง</span>
            </div>

            <!-- Tabs -->
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab(event, 'basic')">
                        <i class="fas fa-cog"></i>
                        การตั้งค่าพื้นฐาน
                    </button>
                    <button class="tab-btn" onclick="switchTab(event, 'widget')">
                        <i class="fas fa-palette"></i>
                        ปรับแต่ง Widget
                    </button>
                    <button class="tab-btn" onclick="switchTab(event, 'advanced')">
                        <i class="fas fa-code"></i>
                        ขั้นสูง
                    </button>
                    <button class="tab-btn" onclick="switchTab(event, 'links')">
                        <i class="fas fa-link"></i>
                        ลิงก์
                    </button>
                </div>
            </div>

            <!-- Basic Settings Tab -->
            <div id="basic-tab" class="tab-content active">
                <div class="form-section">
                    <h3>
                        <i class="fas fa-sliders-h"></i>
                        การตั้งค่าหลัก
                    </h3>
                    <form id="configForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="truewalletPhone">
                                    <i class="fas fa-mobile-alt"></i>
                                    เบอร์ TrueWallet
                                </label>
                                <input type="tel" id="truewalletPhone" placeholder="0801234567" required>
                            </div>

                            <div class="form-group">
                                <label for="streamTitle">
                                    <i class="fas fa-video"></i>
                                    ชื่อสตรีม
                                </label>
                                <input type="text" id="streamTitle" placeholder="ชื่อสตรีมของคุณ" required>
                            </div>

                            <div class="form-group">
                                <label for="alertDuration">
                                    <i class="fas fa-clock"></i>
                                    ระยะเวลาแสดง Alert (มิลลิวินาที)
                                </label>
                                <input type="number" id="alertDuration" min="3000" max="15000" step="1000">
                            </div>

                            <div class="form-group">
                                <label for="minTTSAmount">
                                    <i class="fas fa-volume-up"></i>
                                    ยอดขั้นต่ำสำหรับ TTS (บาท)
                                </label>
                                <input type="number" id="minTTSAmount" min="0" step="1">
                                <div class="description">จำนวนเงินขั้นต่ำที่จะให้ระบบอ่านข้อความออกเสียง</div>
                            </div>

                            <div class="form-group">
                                <label for="enableTTS">
                                    <i class="fas fa-microphone"></i>
                                    เปิดใช้งาน TTS (อ่านข้อความ)
                                </label>
                                <select id="enableTTS">
                                    <option value="true">เปิดใช้งาน</option>
                                    <option value="false">ปิดใช้งาน</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="enableTTSName">
                                    <i class="fas fa-user"></i>
                                    อ่านชื่อคนโดเนท
                                </label>
                                <select id="enableTTSName">
                                    <option value="true">อ่านชื่อด้วย</option>
                                    <option value="false">ไม่อ่านชื่อ</option>
                                </select>
                                <div class="description">เมื่อเปิดใช้งาน TTS จะอ่านชื่อคนโดเนทด้วยหรือไม่</div>
                            </div>

                            <div class="form-group">
                                <label for="enableTTSMessage">
                                    <i class="fas fa-comment"></i>
                                    อ่านข้อความโดเนท
                                </label>
                                <select id="enableTTSMessage">
                                    <option value="true">อ่านข้อความด้วย</option>
                                    <option value="false">ไม่อ่านข้อความ</option>
                                </select>
                                <div class="description">เมื่อเปิดใช้งาน TTS จะอ่านข้อความที่ส่งมาด้วยหรือไม่</div>
                            </div>

                            <div class="form-group">
                                <label for="enableSound">
                                    <i class="fas fa-bell"></i>
                                    เปิดใช้งานเสียงแจ้งเตือน
                                </label>
                                <select id="enableSound">
                                    <option value="true">เปิดใช้งาน</option>
                                    <option value="false">ปิดใช้งาน</option>
                                </select>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Bank Settings Section -->
                <div class="form-section">
                    <h3>
                        <i class="fas fa-university"></i>
                        การตั้งค่าธนาคาร
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="enableBankTransfer">
                                <i class="fas fa-exchange-alt"></i>
                                เปิดใช้งานโอนธนาคาร
                            </label>
                            <select id="enableBankTransfer" onchange="toggleBankSettings()">
                                <option value="false">ปิดใช้งาน</option>
                                <option value="true">เปิดใช้งาน</option>
                            </select>
                            <div class="description">เปิดให้ผู้ชมสามารถโดเนทผ่านการโอนธนาคารได้</div>
                        </div>
                    </div>

                    <div class="bank-settings-group" id="bankSettingsGroup" style="display: none;">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="bankName">
                                    <i class="fas fa-building"></i>
                                    ธนาคาร
                                </label>
                                <select id="bankName">
                                    <option value="">เลือกธนาคาร</option>
                                    <option value="ธนาคารกรุงเทพ">ธนาคารกรุงเทพ (BBL)</option>
                                    <option value="ธนาคารกสิกรไทย">ธนาคารกสิกรไทย (KBANK)</option>
                                    <option value="ธนาคารไทยพาณิชย์">ธนาคารไทยพาณิชย์ (SCB)</option>
                                    <option value="ธนาคารกรุงไทย">ธนาคารกรุงไทย (KTB)</option>
                                    <option value="ธนาคารทหารไทย">ธนาคารทหารไทย (TMB)</option>
                                    <option value="ธนาคารกรุงศรีอยุธยา">ธนาคารกรุงศรีอยุธยา (BAY)</option>
                                    <option value="ธนาคารเกียรตินาคิน">ธนาคารเกียรตินาคิน (KKP)</option>
                                    <option value="ธนาคารซีไอเอ็มบี ไทย">ธนาคารซีไอเอ็มบี ไทย (CIMB)</option>
                                    <option value="ธนาคารยูโอบี">ธนาคารยูโอบี (UOB)</option>
                                    <option value="ธนาคารแลนด์ แอนด์ เฮาส์">ธนาคารแลนด์ แอนด์ เฮาส์ (LH Bank)</option>
                                    <option value="ธนาคารออมสิน">ธนาคารออมสิน (GSB)</option>
                                    <option value="ธนาคารอาคารสงเคราะห์">ธนาคารอาคารสงเคราะห์ (GHB)</option>
                                    <option value="ธนาคารเพื่อการเกษตรและสหกรณ์การเกษตร">
                                        ธนาคารเพื่อการเกษตรและสหกรณ์การเกษตร (BAAC)</option>
                                    <option value="ธนาคารอิสลามแห่งประเทศไทย">ธนาคารอิสลามแห่งประเทศไทย (IBANK)</option>
                                    <option value="ธนาคารไอซีบีซี">ธนาคารไอซีบีซี (ICBC)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="bankAccount">
                                    <i class="fas fa-credit-card"></i>
                                    เลขบัญชี
                                </label>
                                <input type="text" id="bankAccount" placeholder="xxx-x-xxxxx-x" maxlength="20">
                                <div class="description">เลขบัญชีที่จะให้ผู้ชมโอนเงินเข้า (ใช้สำหรับตรวจสอบสลิป)</div>
                            </div>

                            <div class="form-group">
                                <label for="bankAccountName">
                                    <i class="fas fa-id-card"></i>
                                    ชื่อบัญชี
                                </label>
                                <input type="text" id="bankAccountName" placeholder="นาย/นาง ชื่อ นามสกุล"
                                    maxlength="50">
                                <div class="description">ชื่อเจ้าของบัญชีที่ตรงกับธนาคาร</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Widget Customization Tab -->
            <div id="widget-tab" class="tab-content">
                <div class="form-section">
                    <h3>
                        <i class="fas fa-edit"></i>
                        รูปแบบการแสดงผล
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="alertFormat">
                                <i class="fas fa-font"></i>
                                รูปแบบข้อความ Alert
                            </label>
                            <input type="text" id="alertFormat" placeholder="{{user}} โดเนท {{amount}}">
                            <div class="description">ใช้ {{user}} สำหรับชื่อผู้โดเนท และ {{amount}} สำหรับจำนวนเงิน
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="showBackground">
                                <i class="fas fa-image"></i>
                                แสดงพื้นหลัง
                            </label>
                            <select id="showBackground">
                                <option value="true">แสดงพื้นหลัง</option>
                                <option value="false">ไม่แสดงพื้นหลัง (โปร่งใส)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="showIcon">
                                <i class="fas fa-star"></i>
                                แสดงไอคอน
                            </label>
                            <select id="showIcon">
                                <option value="true">แสดงไอคอน</option>
                                <option value="false">ไม่แสดงไอคอน</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="showSparkles">
                                <i class="fas fa-sparkles"></i>
                                แสดงเอฟเฟกต์ Sparkles
                            </label>
                            <select id="showSparkles">
                                <option value="true">แสดงเอฟเฟกต์</option>
                                <option value="false">ไม่แสดงเอฟเฟกต์</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="useCustomGif">
                                <i class="fas fa-film"></i>
                                ใช้ GIF แทนไอคอน
                            </label>
                            <select id="useCustomGif">
                                <option value="false">ใช้ไอคอนอีโมจิ</option>
                                <option value="true">ใช้ GIF ที่กำหนด</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="customGifUrl">
                                <i class="fas fa-link"></i>
                                URL ของ GIF
                            </label>
                            <input type="url" id="customGifUrl" placeholder="https://example.com/animation.gif">
                            <div class="description">ใส่ลิงก์ GIF ที่ต้องการแสดงแทนไอคอน (ขนาดจะถูก resize อัตโนมัติ)
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h3>
                        <i class="fas fa-palette"></i>
                        สีและขนาด
                    </h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="backgroundColor">
                                <i class="fas fa-fill-drip"></i>
                                สีพื้นหลัง
                            </label>
                            <div class="color-input">
                                <input type="color" id="backgroundColorPicker" value="#ffffff">
                                <input type="text" id="backgroundColor" placeholder="rgba(255, 255, 255, 0.95)">
                            </div>
                            <div class="description">สามารถใช้ rgba() สำหรับความโปร่งใส</div>
                        </div>

                        <div class="form-group">
                            <label for="textColor">
                                <i class="fas fa-text-height"></i>
                                สีข้อความ
                            </label>
                            <div class="color-input">
                                <input type="color" id="textColorPicker" value="#1f2937">
                                <input type="text" id="textColor" placeholder="#1f2937">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="donorColor">
                                <i class="fas fa-user-tag"></i>
                                สีชื่อผู้โดเนท
                            </label>
                            <div class="color-input">
                                <input type="color" id="donorColorPicker" value="#667eea">
                                <input type="text" id="donorColor" placeholder="#667eea">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="amountColor">
                                <i class="fas fa-dollar-sign"></i>
                                สีจำนวนเงิน
                            </label>
                            <div class="color-input">
                                <input type="color" id="amountColorPicker" value="#f59e0b">
                                <input type="text" id="amountColor" placeholder="#f59e0b">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="messageColor">
                                <i class="fas fa-comment-dots"></i>
                                สีข้อความโดเนท
                            </label>
                            <div class="color-input">
                                <input type="color" id="messageColorPicker" value="#6b7280">
                                <input type="text" id="messageColor" placeholder="#6b7280">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="fontSize">
                                <i class="fas fa-text-width"></i>
                                ขนาดตัวอักษร: <span id="fontSizeValue">42</span>px
                            </label>
                            <div class="range-input">
                                <input type="range" id="fontSize" min="12" max="100" value="42"
                                    oninput="updateRangeValue('fontSize', 'fontSizeValue')">
                                <div class="range-value" id="fontSizeDisplay">42px</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="amountSize">
                                <i class="fas fa-coins"></i>
                                ขนาดตัวเลขเงิน: <span id="amountSizeValue">56</span>px
                            </label>
                            <div class="range-input">
                                <input type="range" id="amountSize" min="12" max="120" value="56"
                                    oninput="updateRangeValue('amountSize', 'amountSizeValue')">
                                <div class="range-value" id="amountSizeDisplay">56px</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="borderRadius">
                                <i class="fas fa-shapes"></i>
                                ความโค้งมุม: <span id="borderRadiusValue">25</span>px
                            </label>
                            <div class="range-input">
                                <input type="range" id="borderRadius" min="0" max="50" value="25"
                                    oninput="updateRangeValue('borderRadius', 'borderRadiusValue')">
                                <div class="range-value" id="borderRadiusDisplay">25px</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="animationSpeed">
                                <i class="fas fa-running"></i>
                                ความเร็ว Animation: <span id="animationSpeedValue">1.2</span>x
                            </label>
                            <div class="range-input">
                                <input type="range" id="animationSpeed" min="0.1" max="5" step="0.1" value="1.2"
                                    oninput="updateRangeValue('animationSpeed', 'animationSpeedValue')">
                                <div class="range-value" id="animationSpeedDisplay">1.2x</div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="messageSize">
                                <i class="fas fa-text-height"></i>
                                ขนาดข้อความ: <span id="messageSizeValue">24</span>px
                            </label>
                            <div class="range-input">
                                <input type="range" id="messageSize" min="12" max="48" value="24"
                                    oninput="updateRangeValue('messageSize', 'messageSizeValue')">
                                <div class="range-value" id="messageSizeDisplay">24px</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preview Section -->
                <div class="preview-section">
                    <h4>
                        <i class="fas fa-eye"></i>
                        ตัวอย่าง Widget
                    </h4>
                    <div class="preview-widget" id="previewWidget">
                        <div class="preview-alert" id="previewAlert">
                            <div style="font-size: 42px; margin-bottom: 10px;">
                                <span style="color: #667eea; font-weight: 900;">ผู้ทดสอบ</span> โดเนท
                                <span
                                    style="color: #f59e0b; font-size: 56px; font-weight: 900; display: block;">500</span>
                            </div>
                            <div style="font-style: italic; color: #6b7280;">ข้อความทดสอบ</div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        <button type="button" class="btn btn-secondary" onclick="updatePreview()">
                            <i class="fas fa-sync"></i>
                            อัปเดตตัวอย่าง
                        </button>
                    </div>
                </div>
            </div>

            <!-- Advanced Settings Tab -->
            <div id="advanced-tab" class="tab-content">
                <div class="form-section">
                    <h3>
                        <i class="fas fa-cogs"></i>
                        การตั้งค่าขั้นสูง
                    </h3>
                    <div class="form-group">
                        <label for="customCSS">
                            <i class="fas fa-code"></i>
                            Custom CSS
                        </label>
                        <textarea id="customCSS" placeholder="/* ใส่ CSS เพิ่มเติมที่นี่ */"></textarea>
                        <div class="description">CSS สำหรับปรับแต่ง Widget เพิ่มเติม</div>
                    </div>

                    <div class="form-group">
                        <label for="welcomeMessage">
                            <i class="fas fa-comments"></i>
                            ข้อความต้อนรับ
                        </label>
                        <textarea id="welcomeMessage" placeholder="ยินดีต้อนรับสู่สตรีมของฉัน!"></textarea>
                    </div>
                </div>
            </div>

            <!-- Links Tab -->
            <div id="links-tab" class="tab-content">
                <div class="links-section">
                    <h3>
                        <i class="fas fa-external-link-alt"></i>
                        ลิงก์สำหรับ {{ username }}
                    </h3>
                    <div class="links-grid">
                        <div class="link-card">
                            <a href="/user/{{ username }}/donate" target="_blank">
                                <i class="fas fa-gift"></i>
                                Donate Page
                            </a>
                            <div class="desc">สำหรับผู้ชม</div>
                        </div>
                        <div class="link-card">
                            <a href="/user/{{ username }}/widget" target="_blank">
                                <i class="fas fa-tv"></i>
                                Alert Widget
                            </a>
                            <div class="desc">สำหรับ OBS</div>
                        </div>
                        <div class="link-card">
                            <a href="/user/{{ username }}/control" target="_blank">
                                <i class="fas fa-gamepad"></i>
                                Control Panel
                            </a>
                            <div class="desc">ควบคุม Alert</div>
                        </div>
                        <div class="link-card">
                            <a href="/user/{{ username }}/history" target="_blank">
                                <i class="fas fa-history"></i>
                                History
                            </a>
                            <div class="desc">ประวัติการสนับสนุน</div>
                        </div>
                    </div>

                    <!-- OBS Widget URL -->
                    <div class="url-section">
                        <h4>
                            <i class="fas fa-clipboard"></i>
                            URL สำหรับ OBS Browser Source:
                        </h4>
                        <div class="url-display" id="widgetUrl">{{ widgetUrl }}</div>
                        <button class="btn btn-success" onclick="copyUrl('widgetUrl')">
                            <i class="fas fa-copy"></i>
                            คัดลอก Widget URL
                        </button>
                    </div>

                    <!-- Donate URL -->
                    <div class="url-section">
                        <h4>
                            <i class="fas fa-heart"></i>
                            URL สำหรับการโดเนท:
                        </h4>
                        <div class="url-display" id="donateUrl">{{ donateUrl }}</div>
                        <button class="btn btn-success" onclick="copyUrl('donateUrl')">
                            <i class="fas fa-copy"></i>
                            คัดลอก Donate URL
                        </button>
                    </div>
                </div>
            </div>

            <!-- Save Button -->
            <button type="submit" class="save-btn" onclick="saveConfig()">
                <i class="fas fa-save"></i>
                บันทึกการตั้งค่า
            </button>

            <div class="footer-nav">
                <a href="/">
                    <i class="fas fa-arrow-left"></i>
                    กลับหน้าแรก
                </a>
            </div>

            <div id="statusMessage" class="status-message"></div>
        </div>
    </div>

    <script>
        let currentConfig = {};
        let sessionErrorCount = 0;

        // Load current config
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                console.log('🔍 Initializing config page...');

                // ตรวจสอบ session ก่อนโหลดข้อมูล
                const sessionCheckResponse = await fetch('/user/{{ username }}/api/session-status', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    credentials: 'same-origin'
                });

                if (sessionCheckResponse.status === 401) {
                    console.log('❌ Session not valid, redirecting to login...');
                    showStatus('กรุณาเข้าสู่ระบบก่อนเข้าใช้งาน Settings', 'error');

                    setTimeout(() => {
                        const returnUrl = encodeURIComponent(window.location.href);
                        window.location.href = `/user/{{ username }}/login?return=${returnUrl}`;
                    }, 2000);
                    return;
                }

                console.log('✅ Session validation passed');

                // โหลด config
                let configLoaded = false;

                const configResponse = await fetch('/user/{{ username }}/api/config', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                    },
                    credentials: 'same-origin'
                });

                if (configResponse.ok) {
                    const data = await configResponse.json();
                    if (data.success && data.config) {
                        currentConfig = data.config;
                        configLoaded = true;
                        console.log('✅ Config loaded from API:', currentConfig);
                    }
                }

                // Fallback to template data
                if (!configLoaded) {
                    const configStr = `{{ config }}`.trim();
                    if (configStr && configStr !== '{{ config }}' && configStr !== '') {
                        try {
                            const unescapedConfig = configStr
                                .replace(/&quot;/g, '"')
                                .replace(/&amp;/g, '&')
                                .replace(/&lt;/g, '<')
                                .replace(/&gt;/g, '>')
                                .replace(/&#039;/g, "'");

                            currentConfig = JSON.parse(unescapedConfig);
                            configLoaded = true;
                            console.log('✅ Config loaded from template:', currentConfig);
                        } catch (e) {
                            console.warn('Failed to parse config from template:', e);
                        }
                    }
                }

                // Default config
                if (!configLoaded) {
                    console.log('⚠️ Using default config');
                    currentConfig = getDefaultConfig();
                }

                // Setup UI
                populateForm(currentConfig);
                setupColorPickers();
                updatePreview();

                // เริ่ม session keep-alive
                startSessionKeepAlive();

                console.log('🎉 Config page loaded successfully');

            } catch (error) {
                console.error('💥 Error in config initialization:', error);

                // ถ้าเป็น network error
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    showStatus('ไม่สามารถตรวจสอบสิทธิ์ได้ กำลังนำไปหน้าล็อกอิน...', 'error');
                    setTimeout(() => {
                        const returnUrl = encodeURIComponent(window.location.href);
                        window.location.href = `/user/{{ username }}/login?return=${returnUrl}`;
                    }, 2000);
                    return;
                }

                // ใช้ default config และแสดง error
                currentConfig = getDefaultConfig();
                populateForm(currentConfig);
                setupColorPickers();
                updatePreview();

                showStatus('โหลดการตั้งค่าไม่สำเร็จ ใช้ค่าเริ่มต้น', 'error');
            }
        });

        function getDefaultConfig() {
            return {
                truewalletPhone: '',
                streamTitle: '{{ username }}\'s Stream',
                alertDuration: 5000,
                enableTTS: true,
                enableTTSName: true,
                enableTTSMessage: true,
                enableSound: true,
                alertFormat: '{{user}} โดเนท {{amount}}',
                minTTSAmount: 50,

                // Bank settings
                enableBankTransfer: false,
                bankName: '',
                bankAccount: '',
                bankAccountName: '',

                // Widget settings
                showBackground: false,
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                textColor: '#1f2937',
                amountColor: '#f59e0b',
                donorColor: '#667eea',
                messageColor: '#6b7280',
                fontSize: 42,
                amountSize: 56,
                messageSize: 24,
                borderRadius: 25,
                showIcon: true,
                showSparkles: true,
                animationSpeed: 1.2,
                customCSS: '',
                welcomeMessage: 'ยินดีต้อนรับสู่สตรีมของ {{ username }}!',
                useCustomGif: false,
                customGifUrl: ''
            };
        }

        function populateForm(config) {
            // Basic settings
            document.getElementById('truewalletPhone').value = config.truewalletPhone || '';
            document.getElementById('streamTitle').value = config.streamTitle || '';
            document.getElementById('alertDuration').value = config.alertDuration || 5000;
            document.getElementById('minTTSAmount').value = config.minTTSAmount || 50;
            document.getElementById('enableTTS').value = config.enableTTS ? 'true' : 'false';
            document.getElementById('enableTTSName').value = config.enableTTSName !== false ? 'true' : 'false';
            document.getElementById('enableTTSMessage').value = config.enableTTSMessage !== false ? 'true' : 'false';
            document.getElementById('enableSound').value = config.enableSound ? 'true' : 'false';

            // Bank settings
            document.getElementById('enableBankTransfer').value = config.enableBankTransfer ? 'true' : 'false';
            document.getElementById('bankName').value = config.bankName || '';
            document.getElementById('bankAccount').value = config.bankAccount || '';
            document.getElementById('bankAccountName').value = config.bankAccountName || '';

            // Widget customization
            document.getElementById('alertFormat').value = config.alertFormat || '{{user}} โดเนท {{amount}}';
            document.getElementById('showBackground').value = config.showBackground === true ? 'true' : 'false';
            document.getElementById('showIcon').value = config.showIcon !== false ? 'true' : 'false';
            document.getElementById('showSparkles').value = config.showSparkles !== false ? 'true' : 'false';
            document.getElementById('useCustomGif').value = config.useCustomGif === true ? 'true' : 'false';
            document.getElementById('customGifUrl').value = config.customGifUrl || '';
            document.getElementById('backgroundColor').value = config.backgroundColor || 'rgba(255, 255, 255, 0.95)';
            document.getElementById('textColor').value = config.textColor || '#1f2937';
            document.getElementById('amountColor').value = config.amountColor || '#f59e0b';
            document.getElementById('donorColor').value = config.donorColor || '#667eea';
            document.getElementById('messageColor').value = config.messageColor || '#6b7280';
            document.getElementById('fontSize').value = config.fontSize || 42;
            document.getElementById('amountSize').value = config.amountSize || 56;
            document.getElementById('messageSize').value = config.messageSize || 24;
            document.getElementById('borderRadius').value = config.borderRadius || 25;
            document.getElementById('animationSpeed').value = config.animationSpeed || 1.2;

            // Advanced
            document.getElementById('customCSS').value = config.customCSS || '';
            document.getElementById('welcomeMessage').value = config.welcomeMessage || '';

            // Update range displays
            updateRangeValue('fontSize', 'fontSizeValue');
            updateRangeValue('amountSize', 'amountSizeValue');
            updateRangeValue('messageSize', 'messageSizeValue');
            updateRangeValue('borderRadius', 'borderRadiusValue');
            updateRangeValue('animationSpeed', 'animationSpeedValue');

            // Toggle bank settings visibility
            toggleBankSettings();
        }

        function setupColorPickers() {
            // Setup color picker synchronization
            const colorInputs = [
                { picker: 'backgroundColorPicker', text: 'backgroundColor', defaultColor: '#ffffff' },
                { picker: 'textColorPicker', text: 'textColor', defaultColor: '#1f2937' },
                { picker: 'amountColorPicker', text: 'amountColor', defaultColor: '#f59e0b' },
                { picker: 'donorColorPicker', text: 'donorColor', defaultColor: '#667eea' },
                { picker: 'messageColorPicker', text: 'messageColor', defaultColor: '#6b7280' }
            ];

            colorInputs.forEach(({ picker, text }) => {
                const pickerEl = document.getElementById(picker);
                const textEl = document.getElementById(text);

                if (!pickerEl || !textEl) return;

                pickerEl.addEventListener('change', () => {
                    textEl.value = pickerEl.value;
                    updatePreview();
                });

                textEl.addEventListener('input', () => {
                    // ถ้าเป็นสี hex ให้ sync ไป color picker
                    if (textEl.value.startsWith('#') && textEl.value.length === 7) {
                        pickerEl.value = textEl.value;
                    }
                    updatePreview();
                });
            });

            // ซิงค์ค่าเริ่มต้นหลังจาก setup event listeners
            setTimeout(() => {
                syncColorPickers();
            }, 100);
        }

        function syncColorPickers() {
            // ฟังก์ชันสำหรับซิงค์ค่าสีเริ่มต้นระหว่าง color picker และ text input
            const colorInputs = [
                { picker: 'backgroundColorPicker', text: 'backgroundColor', defaultColor: '#ffffff' },
                { picker: 'textColorPicker', text: 'textColor', defaultColor: '#1f2937' },
                { picker: 'amountColorPicker', text: 'amountColor', defaultColor: '#f59e0b' },
                { picker: 'donorColorPicker', text: 'donorColor', defaultColor: '#667eea' },
                { picker: 'messageColorPicker', text: 'messageColor', defaultColor: '#6b7280' }
            ];

            colorInputs.forEach(({ picker, text, defaultColor }) => {
                const pickerEl = document.getElementById(picker);
                const textEl = document.getElementById(text);

                if (!pickerEl || !textEl) return;

                const textValue = textEl.value;

                // ถ้าเป็นสี hex ให้ sync ไป color picker
                if (textValue && textValue.startsWith('#') && textValue.length === 7) {
                    pickerEl.value = textValue;
                } else if (textValue && textValue.startsWith('rgba')) {
                    // ถ้าเป็น rgba ให้แปลงเป็น hex แล้ว sync
                    const hex = rgbaToHex(textValue);
                    if (hex) {
                        pickerEl.value = hex;
                    } else {
                        pickerEl.value = defaultColor;
                    }
                } else {
                    // ถ้าไม่มีค่าหรือค่าไม่ถูกต้อง ใช้ค่า default
                    pickerEl.value = defaultColor;
                    textEl.value = defaultColor;
                }
            });
        }

        function rgbaToHex(rgba) {
            // แปลง rgba เป็น hex (ไม่รวม alpha)
            const match = rgba.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
            if (match) {
                const r = parseInt(match[1]).toString(16).padStart(2, '0');
                const g = parseInt(match[2]).toString(16).padStart(2, '0');
                const b = parseInt(match[3]).toString(16).padStart(2, '0');
                return `#${r}${g}${b}`;
            }
            return null;
        }

        function switchTab(event, tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
        }

        function updateRangeValue(rangeId, valueId) {
            const range = document.getElementById(rangeId);
            const value = document.getElementById(valueId);
            const display = document.getElementById(rangeId + 'Display');

            value.textContent = range.value;
            if (display) {
                display.textContent = range.value + (rangeId === 'animationSpeed' ? 'x' : 'px');
            }

            updatePreview();
        }

        function updatePreview() {
            const preview = document.getElementById('previewAlert');
            const widget = document.getElementById('previewWidget');

            const showBackground = document.getElementById('showBackground').value === 'true';
            const backgroundColor = document.getElementById('backgroundColor').value;
            const textColor = document.getElementById('textColor').value;
            const amountColor = document.getElementById('amountColor').value;
            const donorColor = document.getElementById('donorColor').value;
            const messageColor = document.getElementById('messageColor').value;
            const fontSize = document.getElementById('fontSize').value;
            const amountSize = document.getElementById('amountSize').value;
            const messageSize = document.getElementById('messageSize').value;
            const borderRadius = document.getElementById('borderRadius').value;
            const alertFormat = document.getElementById('alertFormat').value;
            const useCustomGif = document.getElementById('useCustomGif').value === 'true';
            const customGifUrl = document.getElementById('customGifUrl').value;
            const showIcon = document.getElementById('showIcon').value === 'true';

            // Update preview styles
            if (showBackground) {
                preview.style.background = backgroundColor;
                preview.style.border = '1px solid rgba(255,255,255,0.3)';
            } else {
                preview.style.background = 'transparent';
                preview.style.border = 'none';
            }

            preview.style.borderRadius = borderRadius + 'px';
            preview.style.color = textColor;

            // Update text content based on format
            let formattedText = alertFormat
                .replace('{{user}}', `<span style="color: ${donorColor}; font-weight: 900;">ผู้ทดสอบ</span>`)
                .replace('{{amount}}', `<span style="color: ${amountColor}; font-size: ${amountSize}px; font-weight: 900; display: block;">฿500</span>`);

            // Add icon/gif preview
            let iconHtml = '';
            if (showIcon) {
                if (useCustomGif && customGifUrl) {
                    iconHtml = `<div style="width: 80px; height: 80px; margin: 0 auto 15px; border-radius: 50%; overflow: hidden; display: flex; align-items: center; justify-content: center; box-shadow: 0 8px 20px rgba(0,0,0,0.2);">
                        <img src="${customGifUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" onerror="this.style.display='none'">
                    </div>`;
                } else {
                    iconHtml = `<div style="width: 80px; height: 80px; margin: 0 auto 15px; background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);">🎉</div>`;
                }
            }

            preview.innerHTML = `
                ${iconHtml}
                <div style="font-size: ${fontSize}px; margin-bottom: 10px;">
                    ${formattedText}
                </div>
                <div style="font-style: italic; color: ${messageColor}; margin-top: 10px; font-size: ${messageSize}px;">ข้อความทดสอบ</div>
            `;
        }

        function toggleBankSettings() {
            const enableBankTransfer = document.getElementById('enableBankTransfer').value === 'true';
            const bankSettingsGroup = document.getElementById('bankSettingsGroup');

            if (bankSettingsGroup) {
                bankSettingsGroup.style.display = enableBankTransfer ? 'block' : 'none';
            }
        }

        async function saveConfig() {
            const config = {
                truewalletPhone: document.getElementById('truewalletPhone').value,
                streamTitle: document.getElementById('streamTitle').value,
                alertDuration: parseInt(document.getElementById('alertDuration').value),
                enableTTS: document.getElementById('enableTTS').value === 'true',
                enableTTSName: document.getElementById('enableTTSName').value === 'true',
                enableTTSMessage: document.getElementById('enableTTSMessage').value === 'true',
                enableSound: document.getElementById('enableSound').value === 'true',
                minTTSAmount: parseInt(document.getElementById('minTTSAmount').value) || 0,

                // Bank settings
                enableBankTransfer: document.getElementById('enableBankTransfer').value === 'true',
                bankName: document.getElementById('bankName').value,
                bankAccount: document.getElementById('bankAccount').value,
                bankAccountName: document.getElementById('bankAccountName').value,

                // Widget customization
                alertFormat: document.getElementById('alertFormat').value,
                showBackground: document.getElementById('showBackground').value === 'true',
                showIcon: document.getElementById('showIcon').value === 'true',
                showSparkles: document.getElementById('showSparkles').value === 'true',
                useCustomGif: document.getElementById('useCustomGif').value === 'true',
                customGifUrl: document.getElementById('customGifUrl').value,
                backgroundColor: document.getElementById('backgroundColor').value,
                textColor: document.getElementById('textColor').value,
                amountColor: document.getElementById('amountColor').value,
                donorColor: document.getElementById('donorColor').value,
                messageColor: document.getElementById('messageColor').value,
                fontSize: parseInt(document.getElementById('fontSize').value),
                amountSize: parseInt(document.getElementById('amountSize').value),
                messageSize: parseInt(document.getElementById('messageSize').value),
                borderRadius: parseInt(document.getElementById('borderRadius').value),
                animationSpeed: parseFloat(document.getElementById('animationSpeed').value),

                // Advanced
                customCSS: document.getElementById('customCSS').value,
                welcomeMessage: document.getElementById('welcomeMessage').value
            };

            try {
                console.log('💾 Attempting to save config...');

                // ตรวจสอบ session ก่อนบันทึก
                const sessionCheck = await fetch('/user/{{ username }}/api/session-status', {
                    method: 'GET',
                    credentials: 'same-origin'
                });

                if (sessionCheck.status === 401) {
                    throw new Error('SESSION_EXPIRED');
                }

                const response = await fetch('/user/{{ username }}/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(config)
                });

                console.log('📡 Save response status:', response.status);

                // ตรวจสอบ Content-Type ก่อน parse
                const contentType = response.headers.get('Content-Type');

                if (!contentType || !contentType.includes('application/json')) {
                    const responseText = await response.text();

                    if (responseText.includes('<!DOCTYPE') || responseText.includes('<html')) {
                        throw new Error('SESSION_EXPIRED');
                    } else {
                        throw new Error(`Server returned unexpected content type: ${contentType}`);
                    }
                }

                const result = await response.json();
                console.log('📋 Save result:', result);

                if (response.status === 401 || result.code === 'AUTH_REQUIRED') {
                    throw new Error('SESSION_EXPIRED');
                }

                if (response.ok && result.success) {
                    showStatus('บันทึกการตั้งค่าสำเร็จ!', 'success');
                    currentConfig = config;

                    // รีเซ็ต error counter หลังจากบันทึกสำเร็จ
                    sessionErrorCount = 0;
                } else {
                    const errorMessage = result.message || `HTTP ${response.status}: ${response.statusText}`;
                    showStatus('เกิดข้อผิดพลาด: ' + errorMessage, 'error');
                }

            } catch (error) {
                console.error('💥 Save config error:', error);

                if (error.message === 'SESSION_EXPIRED') {
                    showStatus('Session หมดอายุ กำลังนำไปหน้าล็อกอิน...', 'error');
                    setTimeout(() => {
                        window.location.href = `/user/{{ username }}/login?return=${encodeURIComponent(window.location.href)}`;
                    }, 2000);
                } else if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    showStatus('ไม่สามารถเชื่อมต่อกับเซิร์ฟเวอร์ได้', 'error');
                } else {
                    showStatus('เกิดข้อผิดพลาด: ' + error.message, 'error');
                }
            }
        }

        function copyUrl(elementId) {
            const urlElement = document.getElementById(elementId);
            const url = urlElement.textContent;

            if (navigator.clipboard) {
                navigator.clipboard.writeText(url).then(() => {
                    showStatus('คัดลอก URL สำเร็จ!', 'success');
                }).catch(err => {
                    console.error('Error copying URL:', err);
                    fallbackCopy(url);
                });
            } else {
                fallbackCopy(url);
            }
        }

        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');
                showStatus('คัดลอก URL สำเร็จ!', 'success');
            } catch (err) {
                console.error('Fallback copy failed:', err);
                showStatus('ไม่สามารถคัดลอกได้ กรุณาคัดลอกด้วยตนเอง', 'error');
            }

            document.body.removeChild(textarea);
        }

        function showStatus(message, type) {
            const statusMessage = document.getElementById('statusMessage');
            statusMessage.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                ${message}
            `;
            statusMessage.className = `status-message ${type} show`;

            setTimeout(() => {
                statusMessage.classList.remove('show');
            }, 4000);
        }

        // Phone number validation
        document.getElementById('truewalletPhone').addEventListener('input', function (e) {
            const phone = e.target.value;
            const isValid = /^[0-9]{10}$/.test(phone);

            if (phone.length > 0 && !isValid) {
                e.target.style.borderColor = 'var(--error-color)';
                e.target.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
            } else {
                e.target.style.borderColor = 'var(--border-light)';
                e.target.style.boxShadow = 'none';
            }
        });

        // Bank account validation
        document.getElementById('bankAccount').addEventListener('input', function (e) {
            const account = e.target.value;
            // ลบตัวอักษรที่ไม่ใช่ตัวเลขและ dash
            const cleaned = account.replace(/[^0-9-]/g, '');
            e.target.value = cleaned;

            // ตรวจสอบรูปแบบ
            const isValid = /^[\d-]{0,20}$/.test(cleaned);

            if (cleaned.length > 0 && !isValid) {
                e.target.style.borderColor = 'var(--error-color)';
                e.target.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
            } else {
                e.target.style.borderColor = 'var(--border-light)';
                e.target.style.boxShadow = 'none';
            }
        });

        // Bank account name validation
        document.getElementById('bankAccountName').addEventListener('input', function (e) {
            const name = e.target.value;
            // อนุญาตเฉพาะตัวอักษรไทย อังกฤษ และช่องว่าง
            const isValid = /^[a-zA-Zก-๙\s]*$/.test(name);

            if (name.length > 0 && !isValid) {
                e.target.style.borderColor = 'var(--error-color)';
                e.target.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
            } else {
                e.target.style.borderColor = 'var(--border-light)';
                e.target.style.boxShadow = 'none';
            }
        });

        // Auto-update preview when inputs change
        document.addEventListener('input', (e) => {
            if (e.target.closest('#widget-tab')) {
                updatePreview();
            }
        });

        // Session keep-alive
        function startSessionKeepAlive() {
            // ตรวจสอบ session ทุก 2 นาที
            const keepAliveInterval = setInterval(async () => {
                try {
                    console.log('🔄 Checking session status...');

                    const response = await fetch('/user/{{ username }}/api/session-status', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json',
                        },
                        credentials: 'same-origin'
                    });

                    if (response.status === 401) {
                        console.log('❌ Session expired during keep-alive');
                        clearInterval(keepAliveInterval);
                        showStatus('Session หมดอายุ กำลังนำไปหน้าล็อกอิน...', 'error');

                        setTimeout(() => {
                            const returnUrl = encodeURIComponent(window.location.href);
                            window.location.href = `/user/{{ username }}/login?return=${returnUrl}`;
                        }, 2000);
                        return;
                    }

                    if (response.ok) {
                        const sessionInfo = await response.json();
                        if (sessionInfo.authenticated) {
                            console.log('✅ Session is valid, time remaining:', Math.round(sessionInfo.timeRemaining / 1000 / 60), 'minutes');
                            sessionErrorCount = 0; // Reset error count
                        } else {
                            throw new Error('Session not authenticated');
                        }
                    } else {
                        throw new Error(`HTTP ${response.status}`);
                    }

                } catch (error) {
                    console.error('💥 Session keep-alive error:', error);

                    sessionErrorCount = (sessionErrorCount || 0) + 1;
                    if (sessionErrorCount >= 3) {
                        console.log('❌ Too many session errors, redirecting to login');
                        clearInterval(keepAliveInterval);
                        showStatus('เกิดปัญหากับ Session กำลังนำไปหน้าล็อกอิน...', 'error');

                        setTimeout(() => {
                            const returnUrl = encodeURIComponent(window.location.href);
                            window.location.href = `/user/{{ username }}/login?return=${returnUrl}`;
                        }, 2000);
                    }
                }
            }, 2 * 60 * 1000); // ทุก 2 นาที

            // หยุด keep-alive เมื่อออกจากหน้า
            window.addEventListener('beforeunload', () => {
                clearInterval(keepAliveInterval);
            });
        }

        // Initialize preview on load
        window.addEventListener('load', () => {
            updatePreview();
        });
    </script>
</body>

</html>