// utils/UserManager.js - Class ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Users

const fs = require('fs');
const path = require('path');

class UserManager {
    constructor() {
        this.USER_DATA_DIR = path.join(__dirname, '..', 'users');
        this.ensureUserDirectory();
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á folder users ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
    ensureUserDirectory() {
        if (!fs.existsSync(this.USER_DATA_DIR)) {
            fs.mkdirSync(this.USER_DATA_DIR, { recursive: true });
            console.log('üìÅ Created users directory');
        }
    }

    // ‡πÑ‡∏î‡πâ path ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå user
    getUserDataPath(username) {
        return path.join(this.USER_DATA_DIR, `${username}.json`);
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ username ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    validateUsername(username) {
        const errors = [];
        
        if (!username) {
            errors.push('Username is required');
        } else if (!/^[a-zA-Z0-9_-]{3,20}$/.test(username)) {
            errors.push('Username must be 3-20 characters (letters, numbers, _, -)');
        }
        
        return {
            isValid: errors.length === 0,
            errors: errors
        };
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ user ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    userExists(username) {
        return fs.existsSync(this.getUserDataPath(username));
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà)
    loadUserData(username) {
        try {
            const userPath = this.getUserDataPath(username);
            
            if (fs.existsSync(userPath)) {
                const data = JSON.parse(fs.readFileSync(userPath, 'utf8'));
                console.log(`üìñ Loaded data for user: ${username}`);
                return data;
            }
        } catch (error) {
            console.error(`‚ùå Error loading user data for ${username}:`, error);
        }
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• default ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ
        const defaultData = this.createDefaultUserData(username);
        this.saveUserData(username, defaultData);
        return defaultData;
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    createDefaultUserData(username) {
        return {
            username: username,
            createdAt: Date.now(),
            lastActiveAt: Date.now(),
            
            // ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
            config: {
                truewalletPhone: '',
                streamTitle: `${username}'s Stream`,
                alertDuration: 5000,
                enableTTS: true,
                enableSound: true,
                alertPosition: 'top',
                customCSS: '',
                welcomeMessage: `‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏™‡∏π‡πà‡∏™‡∏ï‡∏£‡∏µ‡∏°‡∏Ç‡∏≠‡∏á ${username}!`
            },
            
            // ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô
            donations: [],
            
            // ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
            stats: {
                totalDonations: 0,
                totalAmount: 0,
                averageAmount: 0,
                highestDonation: 0,
                uniqueDonors: 0,
                thisMonthAmount: 0,
                lastDonationAt: null
            },
            
            // ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á
            advanced: {
                webhookUrl: '',
                discordWebhook: '',
                customAlerts: {
                    milestone100: true,
                    milestone500: true,
                    milestone1000: true
                }
            }
        };
    }

    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user
    saveUserData(username, userData) {
        try {
            const userPath = this.getUserDataPath(username);
            userData.lastActiveAt = Date.now();
            
            fs.writeFileSync(userPath, JSON.stringify(userData, null, 2), 'utf8');
            console.log(`üíæ Saved data for user: ${username}`);
            return true;
        } catch (error) {
            console.error(`‚ùå Error saving user data for ${username}:`, error);
            return false;
        }
    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á user ‡πÉ‡∏´‡∏°‡πà
    createUser(username, initialConfig = {}) {
        const validation = this.validateUsername(username);
        
        if (!validation.isValid) {
            throw new Error(`Invalid username: ${validation.errors.join(', ')}`);
        }

        if (this.userExists(username)) {
            throw new Error(`User '${username}' already exists`);
        }

        const userData = this.createDefaultUserData(username);
        
        // ‡πÉ‡∏™‡πà config ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        if (initialConfig.truewalletPhone) {
            userData.config.truewalletPhone = initialConfig.truewalletPhone;
        }
        if (initialConfig.streamTitle) {
            userData.config.streamTitle = initialConfig.streamTitle;
        }

        this.saveUserData(username, userData);
        
        console.log(`‚úÖ Created new user: ${username}`);
        return userData;
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡πÉ‡∏´‡∏°‡πà
    addDonation(username, donationData) {
        const userData = this.loadUserData(username);
        
        const donation = {
            id: Date.now() + Math.floor(Math.random() * 1000),
            timestamp: Date.now(),
            bangkokTime: new Date().toLocaleString('th-TH', { 
                timeZone: 'Asia/Bangkok',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            }),
            name: donationData.name,
            amount: parseInt(donationData.amount),
            message: donationData.message || '',
            paymentMethod: donationData.paymentMethod || 'manual',
            voucherCode: donationData.voucherCode || '',
            phoneNumber: donationData.phoneNumber || '',
            ip: donationData.ip || 'unknown',
            userAgent: donationData.userAgent || 'unknown',
            status: 'completed'
        };

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≠‡∏á array
        userData.donations.unshift(donation);

        // ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡πÅ‡∏Ñ‡πà 1000 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        if (userData.donations.length > 1000) {
            userData.donations = userData.donations.slice(0, 1000);
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
        this.updateStats(userData);

        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        this.saveUserData(username, userData);

        console.log(`üí∞ New donation for ${username}: ${donation.name} - ‡∏ø${donation.amount}`);
        return donation;
    }

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥
    updateStats(userData) {
        const donations = userData.donations;
        
        userData.stats.totalDonations = donations.length;
        userData.stats.totalAmount = donations.reduce((sum, d) => sum + d.amount, 0);
        userData.stats.averageAmount = donations.length > 0 ? 
            Math.round(userData.stats.totalAmount / donations.length) : 0;
        userData.stats.highestDonation = donations.length > 0 ? 
            Math.max(...donations.map(d => d.amount)) : 0;
        
        // ‡∏ô‡∏±‡∏ö unique donors
        const uniqueDonors = new Set(donations.map(d => d.name.toLowerCase()));
        userData.stats.uniqueDonors = uniqueDonors.size;
        
        // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
        const thisMonth = new Date();
        const startOfMonth = new Date(thisMonth.getFullYear(), thisMonth.getMonth(), 1);
        userData.stats.thisMonthAmount = donations
            .filter(d => new Date(d.timestamp) >= startOfMonth)
            .reduce((sum, d) => sum + d.amount, 0);
        
        // ‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏±‡∏ö‡∏™‡∏ô‡∏∏‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
        userData.stats.lastDonationAt = donations.length > 0 ? donations[0].timestamp : null;
    }

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
    updateConfig(username, newConfig) {
        const userData = this.loadUserData(username);
        userData.config = { ...userData.config, ...newConfig };
        this.saveUserData(username, userData);
        
        console.log(`‚öôÔ∏è Updated config for ${username}`);
        return userData.config;
    }

    // ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠ users ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    getAllUsers() {
        try {
            const files = fs.readdirSync(this.USER_DATA_DIR);
            const users = files
                .filter(file => file.endsWith('.json'))
                .map(file => {
                    const username = file.replace('.json', '');
                    const userData = this.loadUserData(username);
                    return {
                        username: username,
                        streamTitle: userData.config.streamTitle,
                        totalDonations: userData.stats.totalDonations,
                        totalAmount: userData.stats.totalAmount,
                        lastActiveAt: userData.lastActiveAt,
                        createdAt: userData.createdAt
                    };
                })
                .sort((a, b) => b.lastActiveAt - a.lastActiveAt); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏° active ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î

            return users;
        } catch (error) {
            console.error('Error getting user list:', error);
            return [];
        }
    }

    // ‡∏•‡∏ö user (‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ß‡∏±‡∏á!)
    deleteUser(username) {
        try {
            const userPath = this.getUserDataPath(username);
            
            if (fs.existsSync(userPath)) {
                fs.unlinkSync(userPath);
                console.log(`üóëÔ∏è Deleted user: ${username}`);
                return true;
            }
            
            return false;
        } catch (error) {
            console.error(`Error deleting user ${username}:`, error);
            return false;
        }
    }

    // ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏£‡∏ß‡∏°
    getGlobalStats() {
        const users = this.getAllUsers();
        
        return {
            totalUsers: users.length,
            totalDonations: users.reduce((sum, u) => sum + u.totalDonations, 0),
            totalAmount: users.reduce((sum, u) => sum + u.totalAmount, 0),
            activeUsers: users.filter(u => Date.now() - u.lastActiveAt < 7 * 24 * 60 * 60 * 1000).length, // active ‡πÉ‡∏ô 7 ‡∏ß‡∏±‡∏ô
            topUsers: users
                .sort((a, b) => b.totalAmount - a.totalAmount)
                .slice(0, 5)
                .map(u => ({
                    username: u.username,
                    streamTitle: u.streamTitle,
                    totalAmount: u.totalAmount
                }))
        };
    }
}

module.exports = UserManager;